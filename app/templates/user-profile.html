{% extends "__base_ui__.html" %}

{% block title %}{{ gettext("%(user)s's Profile", user=user.full_name) }}{% endblock %}

{% from "_macros.html" import get_user_avatar_url, render_tab_bar, render_tab_panel, render_user_mailto_link %}

{% set is_current_user_profile = (user.id == current_user.id) %}

{% set tabs = [
  ('overview', gettext('Overview')),
  ('expertise', gettext('Expertise')),
] %}

{% set active_tab = active_tab|default(tabs[0][0]) %}

{% block body_class -%}
{%- if not is_current_user_profile -%}
b-public-profile
{%- endif -%}
{%- endblock %}

{% block content %}

<section class="b-profile-header">
    <div class="e-bg" style="background-image: url('{{ get_user_avatar_url(user) }}')"></div> 
    <div class="e-left">
        <img src="{{ get_user_avatar_url(user) }}" alt="" class="e-picture">
        {% if is_current_user_profile %}
        <a href="{{ url_for('views.my_profile') }}" class="e-edit material-icons">edit</a>
        {% else %}
        {% call render_user_mailto_link(user) %}<span class="e-send material-icons">send</span>{% endcall %}
        {% endif %}
    </div>
    <div class="e-right">
        <h2 class="e-name">{{ user.full_name }}</h2>
        <h3 class="e-job">{{ user.position }}</h3>

        <ul class="e-info">
           {% if user.organization %}
             <li><span class="material-icons">business</span>{{ user.organization }}</li> 
           {% endif %}

           {% if user.expertise_domain_names %}
             {% for domain in user.expertise_domain_names %}
               <li><span class="material-icons">school</span>{{ domain }}</li>
             {% endfor %}
           {% endif %}

           {% if user.full_location %}
           <li><span class="material-icons">location_on</span>{{ user.full_location }}</li> 
           {% endif %}

           {% if user.locales %}
             {% for locale in user.locales %}
               <li>{{ locale.get_display_name(locale=get_locale()) }}</li>
             {% endfor %}
           {% endif %}
        </ul>
    </div>
</section>

{{ render_tab_bar(tabs, active_tab) }}

<div> <!-- Start of tab panel container -->

{% call render_tab_panel('overview', active_tab) %}

<div class="radarChart"></div>

<h3>{{ gettext('Projects I have done') }}</h3>
{% if user.projects %}
<pre>{{ user.projects }}</pre>
{% else %}
{{ gettext("No project information provided.") }}
{% endif %}

{% endcall %}

{% if is_current_user_profile %}

{% if question %}
  {% call render_tab_panel('expertise', active_tab) %}
  {% include "_profile-questionnaire.html" %}
  {% endcall %}
{% else %}
  {% call render_tab_panel('expertise', active_tab, class='b-profile-progress') %}
  {% include "_profile-progress.html" %}
  {% endcall %}
{% endif %}

{% else %}

{% if areaid %}
  {% call render_tab_panel('expertise', active_tab, class="b-expertise") %}
  {% include "_profile-expertise-match-area.html" %}
  {% endcall %}
{% else %}
  {% call render_tab_panel('expertise', active_tab, class="b-match-me") %}
  {% include "_profile-expertise-match.html" %}
  {% endcall %}
{% endif %}

{% endif %}

</div> <!-- End of tab panel container -->

{% endblock %}

{% block page_script %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
<script src="{{ url_for('static', filename='js/radarchart.js') }}"></script>
<script>
// This was taken from bl.ocks.org/nbremer/21746a9668ffdf6d8242
// and modified a bit for NoI.

    ////////////////////////////////////////////////////////////// 
      //////////////////////// Set-Up ////////////////////////////// 
      ////////////////////////////////////////////////////////////// 

      var margin = {top: 100, right: 100, bottom: 100, left: 100},
        width = Math.min(700, window.innerWidth - 10) - margin.left - margin.right,
        height = Math.min(width, window.innerHeight - margin.top - margin.bottom - 20);
          
      ////////////////////////////////////////////////////////////// 
      ////////////////////////// Data ////////////////////////////// 
      ////////////////////////////////////////////////////////////// 

      var levelLabels = [
        {{ gettext("Peer")|tojson }},
        {{ gettext("Connector")|tojson }},
        {{ gettext("Explainer")|tojson }},
        {{ gettext("Practitioner")|tojson }},
        ""
      ].reverse();

      var data = [
            [
{% for questionnaire_id, score in user.get_area_scores().items() %}
    {"axis": {{ gettext(QUESTIONNAIRES_BY_ID[questionnaire_id].name)|tojson }},
     "value": {{ score }}}{% if not loop.last %},{% endif %}
{% endfor %}
            ]
          ];
      ////////////////////////////////////////////////////////////// 
      //////////////////// Draw the Chart ////////////////////////// 
      ////////////////////////////////////////////////////////////// 

      var color = d3.scale.ordinal()
        .range(["#EDC951"]);
        
      var radarChartOptions = {
        w: width,
        h: height,
        margin: margin,
        maxValue: 500,
        levels: 5,
        roundStrokes: true,
        color: color,
        labelForLevel: function(d, i) {
          return levelLabels[i];
        }
      };

      var renderChart = function() {
        RadarChart(".radarChart", data, radarChartOptions);
      };

      if ($('#overview.active').length) {
        renderChart();
      } else {
        $('a[href="#overview"]').one('shown.bs.tab', renderChart);
      }
</script>
{% endblock %}
